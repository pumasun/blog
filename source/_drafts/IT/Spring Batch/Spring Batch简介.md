---
title: Spring Batch简介
date: 2023-07-11 16:41
---

[参考](https://docs.spring.io/spring-batch/docs/current/reference/html/index-single.html#spring-batch-intro)


# Spring Batch不是一个调度框架。
Spring Batch旨在与调度器协同工作，而不是取代调度器。常见调度器:
- Quartz
- Tivoli
- Control-M
- 其他


# Spring Batch提供了在处理大量记录时必不可少的可重用功能:
- 日志记录和跟踪
- 事务管理
- 作业处理统计
- 作业重启、跳过
- 资源管理

# 支持极高容量和高性能
通过优化和分区技术支持极高容量和高性能的批处理作业。大容量批处理作业可以以高度可伸缩的方式使用该框架来处理大量信息。
- 简单用例, 如将文件读入数据库或运行存储过程
- 复杂的大容量用例, 如在数据库之间移动大容量数据、转换数据等

# 典型的batch处理
1. 从数据库、文件或队列中读取大量记录。
2. 以某种方式处理数据。
3. 以修改后的形式回写数据。

# 应用场景
- 定期提交批处理进程。
- 并发批处理:对一个作业进行并行处理。
- 分阶段的、企业消息驱动的处理。
- 大规模并行批处理。
- 故障后手动或定时重启。
- 相关步骤的顺序处理(扩展到工作流驱动的批处理)。
- 部分处理:跳过记录(例如，回滚时)。
- 整批事务，适用于小批量或已有存储过程或脚本的情况。

# 技术目标
- 让批处理开发人员使用Spring编程模型:专注于业务逻辑，让框架负责基础设施。
- 在基础设施、批处理执行环境和批处理应用程序之间提供清晰的关注点分离。
- 提供通用的核心执行服务作为所有项目都可以实现的接口。
- 提供核心执行接口的简单和默认实现，可以“开箱即用”。
- 通过在所有层中使用Spring框架，使配置、自定义和扩展服务变得容易。
- 所有现有的核心服务都应该易于替换或扩展，而不会对基础设施层造成任何影响。
- 提供一个简单的部署模型，其中架构jar与应用程序完全分离，使用Maven构建。

# 架构
## Application
包含所有批处理作业和开发人员使用Spring批处理编写的自定义代码。

## Core
包含启动和控制批处理作业所需的核心运行时类。它包括对JobLauncher、Job和Step的实现。

## Infrastructure
Application和Core都构建在公共基础设施之上。
包含通用的阅读器、编写器(如ItemReader和ItemWriter)和服务(如RetryTemplate)和核心框架本身。

# Batch开发的原则与方针
- 请记住，批处理架构通常会影响在线架构，反之亦然。在设计时尽可能使用公共构建块，同时考虑架构和环境。
- 尽可能简化并避免在单个批处理应用程序中构建复杂的逻辑结构。
- 使数据的处理和存储在物理上靠近在一起(换句话说，将数据保存在处理发生的地方)。
- 尽量减少系统资源的使用，尤其是I/O。在内部内存中执行尽可能多的操作。
- 检查应用程序I/O(分析SQL语句)，确保避免不必要的物理I/O。特别需要注意以下四个常见的缺陷:
  - 当数据可以被读取一次并缓存或保存在工作存储中时，为每个事务读取数据。
  - 为一个事务重新读取数据，而该数据在同一事务中较早时候被读取过。
  - 导致不必要的表或索引扫描。
  - 没有在SQL语句的WHERE子句中指定键值。
- 不要在一次批量运行中做重复的工作。例如，如果您需要为报告目的汇总数据，那么您应该(如果可能的话)增加在初始处理数据时存储的总数，这样您的报告应用程序就不必重新处理相同的数据。
- 在批处理应用程序开始时分配足够的内存，以避免过程中耗时的重新分配。
- 在数据完整性方面，总是假设最坏的情况。插入适当的检查和记录验证以维护数据完整性。
- 在可能的情况下为内部验证实现校验和。例如，平面文件应该有一个尾记录，告诉文件中的记录总数和关键字段的集合。
- 尽可能早地在具有实际数据量的类似生产的环境中计划和执行压力测试。
- 在大型批处理系统中，备份可能是一项挑战，特别是在系统与在线应用程序全天候并发运行的情况下。数据库备份通常在在线设计中得到很好的处理，但是文件备份也应该被认为同样重要。如果系统依赖于平面文件，那么文件备份过程不仅应该准备好并记录下来，还应该定期进行测试。


# Batch处理策略
为了帮助设计和实现批处理系统，应该以样例结构图和代码模板的形式向设计人员和程序员提供基本的批处理应用程序构建块和模式。

## 业务逻辑分解
在开始设计批处理作业时，应该将业务逻辑分解为一系列步骤，这些步骤可以通过使用以下标准构建块来实现:
1. 转换应用程序
   - 对于由外部系统提供或为外部系统生成的每种类型的文件，必须创建转换应用程序来将提供的事务记录转换为处理所需的标准格式。
   - 这种类型的批处理应用程序可以部分或全部由转换实用工具模块组成。
2. 验证应用程序
   - 确保所有输入和输出记录都是正确和一致的。
   - 验证通常基于文件头和尾、校验和和验证算法以及记录级交叉检查。
3. 提取应用程序
   - 从数据库或输入文件中读取一组记录（READ）
   - 根据预定义的规则选择记录（FILTER）
   - 将记录写入输出文件（WRITE）
4. 提取/更新应用程序
   - 从数据库或输入文件读取记录
   - 根据每个输入记录中的数据对数据库或输出文件进行更改
5. 处理和更新应用程序
   - 对来自提取(Step3)或验证(Step4)应用程序的输入事务执行处理。
   - 处理通常包括读取数据库以获取处理所需的数据，可能会更新数据库并为输出处理创建记录。
6. 输出/格式应用程序
   - 读取输入文件
   - 根据标准格式从该记录中重构数据
   - 产生输出文件用于打印或传输到另一个程序或系统

## 标准工具步骤
- **排序**:读取输入文件并产生输出文件的程序，其中的记录已根据记录中的排序键字段重新排序。排序通常由标准系统实用程序执行。
- **拆分**:读取单个输入文件并根据字段值将每条记录写入几个输出文件之一的程序。拆分可以通过参数驱动的标准系统实用程序进行裁剪或执行。
- **合并**:从多个输入文件中读取记录，并将输入文件中的数据合并生成一个输出文件的程序。合并可以由参数驱动的标准系统工具进行裁剪或执行。


## Batch应用的驱动方式
- **数据库驱动**的应用程序由从数据库检索的行或值驱动。
- **文件驱动**的应用程序由从文件检索到的记录或值驱动。
- **消息驱动**的应用程序由从消息队列检索的消息驱动。

## 影响批处理策略的因素
- 批处理系统容量
- 与在线系统的并发性
- 与其他批处理系统的并发性
- 可用的批处理窗口, 随着越来越多的企业希望全天候运行，清晰的批处理窗口正在消失

## 批处理的典型处理选项有(按执行复杂度的递增顺序):
- 脱机模式下批处理窗口期间的正常处理
- 并发批处理/在线处理
- 同时并行处理多个不同的批处理运行或作业
- 分区(同时处理同一作业的多个实例)。
- 上述选项的组合。